import * as express from "express";
import * as cors from "cors";

const uuid = require('uuidv4');
const mysql = require('mysql');
const bodyParser = require('body-parser');
const connection = mysql.createConnection({
    host: 'localhost',
    user: 'SDE_User',
    password: 'Password123',
    database: 'sda'
});

var ids: [string, string][] = [];

export class Server {
    public app: express.Application;

    constructor() {
        this.app = express();
        this.app.use(cors());
        this.app.use(bodyParser.urlencoded({ extended: false }))
        this.app.use(bodyParser.json());
        //this.app.use(this.authentificte);
        this.app.get('/login/:usr.:pwd', this.loginHandler); // SDA #1
        this.app.get('/sensorData', this.getSensorHandler);
        this.app.get('/history', this.gethistory);
        this.app.get('/name', this.getUserName);
        this.app.put('/v', this.setSensorHandler);
        this.app.put('/sname', this.setSensorName);
        this.app.put('/ur', this.setUsername);
        this.app.put('/pw', this.setPassword);
        this.app.listen(3003);
    }

    private loginHandler(req, res) {
        let username = req.params.usr;
        let password = req.params.pwd;

        const query = "Select * FROM users WHERE username = ?";
        connection.query(query, [username], (err, rows, fields) => {
            if (err) {
                console.log(err);
                res.sendStatus(500);
                return;
            }

            if (rows.length == 1 && rows[0].password == password) {
                var token = uuid();
                var foundToken = false;

                ids.forEach(elm => {
                    if (elm[0] == username) {
                        elm[1] = token;
                        foundToken = true;
                    }
                });

                if (!foundToken) {
                    var pair: [string, string] = [username, token];
                    ids.push(pair);
                }

                res.send(token);
                return;
            }
            else {
                res.sendStatus(500);
                return;
            }
        })
    }

    private setSensorHandler = (req, res) => {
        let id = req.body.id;
        let value = req.body.value;

        const query = "UPDATE sensorvalues SET value = ? where id = ?";
        connection.query(query, [value, id], (err, rows, fields) => {
            if (err) {
                console.log(err);
                res.sendStatus(500);
                return;
            } else {
                const query2 = "SELECT * FROM sensorvalues WHERE id = ?";
                connection.query(query2, [id], (err, rows, fields) => {
                    if (err) {
                        console.log(err);
                        res.sendStatus(500);
                        return;
                    } else {
                        res.json(rows);
                        this.log('Set ' + rows[0].label + ' to ' + value);
                        return;
                    }
                })
            }
        })
    }

    private getSensorHandler(req, res) {

        const query = "Select * FROM sensorvalues";
        connection.query(query, (err, rows, fields) => {
            if (err) {
                console.log(err);
                res.sendStatus(500);
                return;
            } else {
                res.json(rows);
                return;
            }
        })
    }

    private setSensorName= (req, res) => {
        let newname = req.body.newname;
        let name = req.body.name;

        const query = "UPDATE sensorvalues SET label = ? where label = ?";
        connection.query(query, [newname, name], (err, rows, fields) => {
            if (err) {
                console.log(err);
                res.sendStatus(500);
                return;
            } else {
                res.json(newname);                
                this.log('Changed name of ' + name + ' to ' + newname);
            }
        })
    }

    private getUserName = (req, res) => {
        ids.forEach(id => {
            if (id[1] == req.header('Authorization')) {
                res.json(id[0]);
                return;                
            }
            else {
                res.json('Guest');
                return;
            }
        }); 
    }

    private setPassword= (req, res) => {
        let newpw = req.body.newpw;
        let user;

        ids.forEach(id => {
            if (id[1] == req.header('Authorization')) {
                user = id[0];                
            }
        });        

        const query = "UPDATE users SET password = ? where username = ?";
        connection.query(query, [newpw, user], (err, rows, fields) => {
            if (err) {
                console.log(err);
                res.sendStatus(500);
                return;
            } else {
                res.sendStatus(204);                
                this.log('Changed password of ' + user + ' to ' + newpw);
            }
        })
    }

    private setUsername = (req, res) => {
        let newname = req.body.newname;
        let user;

        ids.forEach(id => {
            if (id[1] == req.header('Authorization')) {
                user = id[0];                
            }
        });

        const query = "UPDATE users SET username = ? where username = ?";
        connection.query(query, [newname, user], (err, rows, fields) => {
            if (err) {
                console.log(err);
                res.sendStatus(500);
                return;
            } else {
                res.json(newname);                
                this.log('Changed username of ' + user + ' to ' + newname);

                ids.forEach(id => {
                    if (id[1] == req.header('Authorization')) {
                        id[0] = newname;                
                    }
                });
            }
        })
    }

    private gethistory(req, res) {
        const query = "Select * FROM history";
        connection.query(query, (err, rows, fields) => {
            if (err) {
                console.log(err);
                res.sendStatus(500);
                return;
            } else {
                res.json(rows);
                return;
            }
        })
    }

    private authentificte(req: express.Request, res: express.Response, next: express.NextFunction) {

        if (req.url.startsWith('/login')) {
            next();
        } else {
            if (req.header('Authorization') == null) {
                res.status(401).send('Unauthorized');
            } else {
                ids.forEach(id => {
                    if (id[1] == req.header('Authorization')) {
                        next();
                        return;
                    }
                    else {
                        res.status(401).send('Unauthorized');
                    }
                });
            }
        }
    }

    private log = (message: string) => {

        const query = "INSERT INTO history (dataset) VALUES (?)";
        connection.query(query, [message], (err, rows, fields) => {
            if (err) {
                console.log(err);
                return;
            } else {
            }
        })
    }
}

new Server();