import * as express from "express";
import * as path from "path";
import * as cors from "cors";

const uuid = require('uuidv4');
const mysql = require('mysql');

var ids: [string,string][] = []; 

export class Server {
    public app: express.Application;

    constructor() {
        this.app = express();
        this.app.use(cors());
        this.app.use(this.authentificte);
        this.app.get('/login/:usr.:pwd', this.loginHandler);
        this.app.listen(3003);
    }

    private loginHandler(req, res) {
        let username = req.params.usr;
        let password = req.params.pwd;

        const connection = mysql.createConnection({
            host: 'localhost',
            user: 'SDE_User',
            password: 'Password123',
            database: 'sda'
        });

        const query = "Select * FROM users WHERE username = ?";
        connection.query(query, [username], (err, rows, fields) => {            
            if(err){
                console.log(err);
                res.sendStatus(500);
                return;
            }
            
            if(rows.length == 1 && rows[0].password == password){
                var token = uuid();                              
                var foundToken = false;

                ids.forEach(elm => {
                    if(elm[0] == username){
                        elm[1] = token;
                        foundToken = true;
                    }
                });

                if(!foundToken){                    
                   var pair:[string, string] = [username, token];
                   ids.push(pair);
                }
                
                res.send(token);
                return;
            } 
            else{                
                res.sendStatus(500);
                return;
            }            
        })
    }

    private authentificte(req: express.Request, res: express.Response, next: express.NextFunction) {

        // I would have used startsWidth('/login') or contains('/login') but those methods strangly cause a typescrip compiler error.
        if (req.url.startsWith('/login')) {
            next();
        } else {
            if (req.header('Authorization') == null) {
                res.status(401).send('Unauthorized');
            } else {
                ids.forEach(id => {
                    if(id[1] == req.header('Authorization')){
                        next();
                        return;
                    }
                    else{                        
                        res.status(401).send('Unauthorized');
                    }
                });
            }
        }
    }
}

new Server();